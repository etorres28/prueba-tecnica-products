<!--
  Archivo: products.component.html
  Descripci√≥n: Plantilla principal del componente de productos.
  
  Funcionalidades:
  - Buscar productos por nombre
  - Filtrar productos por categor√≠a
  - Agregar y editar productos mediante un formulario reactivo
  - Validaciones en todos los campos del formulario
  - Listar productos con paginaci√≥n
  - Ver detalle de un producto (en ruta /producto/:id)
  - Confirmar acciones mediante modal Bootstrap

  Este archivo se conecta con:
  - products.component.ts (l√≥gica)
  - categoryFilter.pipe.ts (filtro de categor√≠a)
  - product.service.ts (gesti√≥n de datos)
-->

<div class="container py-4">
  <h2>üõçÔ∏è Productos</h2>

  <!-- Header y filtros de b√∫squeda -->
  <div class="d-flex gap-3 align-items-end mb-3">
    <div class="flex-grow-1">

      <!-- Input para buscar por nombre -->
      <label for="searchInput" class="form-label">Buscar</label>
      <input
        id="searchInput"
        type="text"
        class="form-control"
        [formControl]="searchControl"
        placeholder="Buscar productos..."
      />
    </div>
    <div>

      <!-- Select para filtrar por categor√≠a existente -->
      <label for="categorySelect" class="form-label">Categor√≠a</label>
      <select
        id="categorySelect"
        class="form-select"
        [formControl]="categoryControl"
      >
        <option value="all">Todas las categor√≠as</option>
        <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
      </select>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        {{ isEditing ? "Editar producto" : "Agregar producto" }}
      </h5>
    </div>

    <!-- Formulario para agregar o editar producto -->
    <div class="card-body">
      <form [formGroup]="form" (ngSubmit)="submitForm()" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">T√≠tulo</label>

          <!-- Campo T√≠tulo con validaci√≥n -->
          <input type="text" class="form-control" formControlName="title" />
          <div
            class="text-danger"
            *ngIf="form.get('title')?.invalid && form.get('title')?.touched"
          >
            El t√≠tulo es obligatorio.
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Precio</label>

          <!-- Campo Precio con validaci√≥n num√©rica -->
          <input type="number" class="form-control" formControlName="price" />
          <div
            class="text-danger"
            *ngIf="form.get('price')?.invalid && form.get('price')?.touched"
          >
            El precio debe ser mayor a 0.
          </div>
        </div>

        <div class="col-12">

          <!-- Campo Descripci√≥n con validaci√≥n -->
          <label class="form-label">Descripci√≥n</label>
          <textarea
            class="form-control"
            formControlName="description"
            rows="3"
          ></textarea>
          <div
            class="text-danger"
            *ngIf="
              form.get('description')?.invalid &&
              form.get('description')?.touched
            "
          >
            La descripci√≥n es obligatoria.
          </div>
        </div>

        <div class="col-12">

          <!-- Campo Categor√≠a con validaci√≥n personalizada -->
          <label class="form-label">Categor√≠a</label>
          <select class="form-select" formControlName="category">
            <option value="" disabled selected>Selecciona una categor√≠a</option>
            <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
          </select>          
          <div
            class="text-danger"
            *ngIf="form.get('category')?.errors?.['required'] && form.get('category')?.touched"
          >
            La categor√≠a es obligatoria.
          </div>
          <div
            class="text-danger"
            *ngIf="form.get('category')?.errors?.['invalidCategory'] && form.get('category')?.touched"
          >
            La categor√≠a debe ser una de las existentes.
          </div>
        </div>

        <!-- Botones de acci√≥n: Agregar / Actualizar / Cancelar -->
        <div class="col-12 d-flex gap-2">
          <button
            type="submit"
            class="btn btn-success"
            [disabled]="form.invalid"
          >
            {{ isEditing ? "Actualizar" : "Agregar" }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="resetForm()">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de productos en cards -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <div
      class="col"
      *ngFor="
        let product of displayedProducts
          | categoryFilter : categoryControl.value ?? 'all'
      "
    >
    <!-- Card de producto -->
      <div class="card h-100">
        <img
          [src]="product.image"
          class="card-img-top p-4"
          style="height: 200px; object-fit: contain"
        />
        <div class="card-body">
          <h5 class="card-title">{{ product.title }}</h5>
          <p class="card-text fw-bold">{{ product.price | currency }}</p>
        </div>

        <!-- Botones: Editar / Eliminar / Ver detalle -->
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-warning" (click)="editProduct(product)">
            ‚úèÔ∏è Editar
          </button>
          <button
            class="btn btn-sm btn-danger"
            (click)="deleteProduct(product.id)"
          >
            üóëÔ∏è Eliminar
          </button>
          <a
            [routerLink]="['/producto', product.id]"
            class="btn btn-sm btn-info"
            >üîç Ver detalle</a
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Controles de paginaci√≥n Bootstrap -->
  <nav class="mt-4 d-flex justify-content-center">
    <ul class="pagination">

      <!-- Anterior / P√°gina actual / Siguiente -->
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button
          class="page-link"
          (click)="prevPage()"
          [disabled]="currentPage === 1"
        >
          Anterior
        </button>
      </li>
      <li class="page-item disabled">
        <span class="page-link">P√°gina {{ currentPage }}</span>
      </li>
      <li class="page-item" [class.disabled]="!hasNextPage()">
        <button
          class="page-link"
          (click)="nextPage()"
          [disabled]="!hasNextPage()"
        >
          Siguiente
        </button>
      </li>
    </ul>
  </nav>

  <!-- Modal para mostrar mensajes (agregado, editado, eliminado) -->
  <div
    class="modal fade show d-block"
    tabindex="-1"
    role="dialog"
    *ngIf="showModal"
  >
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ modalTitle }}</h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeModal()"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>{{ modalMessage }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" (click)="closeModal()">
            Aceptar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de fondo oscuro cuando se muestra el modal -->
  <div class="modal-backdrop fade show" *ngIf="showModal"></div>
</div>
